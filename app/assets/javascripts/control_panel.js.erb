'use strict';

(function() {
  var ledTimeout = null;

  function ledsService() {
    $.ajax({
      type: 'POST',
      url : 'api/colorize_leds.json',
      data: {
        power_on: $('#leds-switch').prop('checked'),
        color   : {
          red  : slide2value('#slide-red'),
          green: slide2value('#slide-green'),
          blue : slide2value('#slide-blue')
        }
      }
    });
  }

  function slide2value(slideSelector) {
    return parseInt($(slideSelector).attr('data-slider') * 255 / 100);
  }

  function value2slide(slideSelector, dec) {
    var value = dec * 100 / 255;
    $(slideSelector).foundation('slider', 'set_value', value);
  }

  function getSelectedRgbColor() {
    return 'rgb(' + slide2value('#slide-red') + ',' + slide2value('#slide-green') + ',' + slide2value('#slide-blue') + ')';
  }

  function colorizeLedsSwitch() {
    var ledsOn = $('#leds-switch').prop('checked');
    var rgb = ledsOn ? getSelectedRgbColor() : '';

    $('#leds-switch-label').css({'background': rgb});
  }

  function switchLeds(event) {
    colorizeLedsSwitch();
    if(typeof event !== 'undefined') {
      window.clearTimeout(ledTimeout);
      ledTimeout = setTimeout(ledsService, 500);
    }
  }

  function updatePanel(data) {
    if(data.action === 'switch_led') {
      $('#leds-switch').prop('checked', data.power_on === 'true');
      value2slide('#slide-red', data.color.red);
      value2slide('#slide-green', data.color.green);
      value2slide('#slide-blue', data.color.blue);
      colorizeLedsSwitch();
    }
  }

  $(function(){
    $('[data-slider]').on('change.fndtn.slider', switchLeds);
    $('#leds-switch').click(switchLeds);

    var faye = new Faye.Client('<%= Rails.application.config.aigor.websockets_url %>');
    faye.subscribe('/control_panel/messages', updatePanel);
  });

})();
